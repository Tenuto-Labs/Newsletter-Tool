<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tenuto Newsletter Development Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase JS (UMD) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-page: #f4f2ec;
      --bg-shell: #f8f7f2;
      --bg-panel: #ffffff;
      --bg-panel-soft: #f2efe7;
      --border-subtle: #d2c9b8;
      --accent: #b12b2b;
      --accent-soft: #e0b3b3;
      --text-main: #111111;
      --text-muted: #666666;
      --danger: #b91c1c;
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; }

    body {
      font-family: "Georgia", "Times New Roman", serif;
      background: var(--bg-page);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: stretch;
      overflow: hidden;
    }

    .app-shell {
      width: 100%;
      max-width: 1200px;
      margin: 16px;
      background: var(--bg-shell);
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      display: grid;
      grid-template-columns: 300px minmax(0, 1fr);
      overflow: hidden;
      height: calc(100vh - 32px);
    }

    .sidebar {
      background: var(--bg-panel-soft);
      border-right: 1px solid var(--border-subtle);
      padding: 12px;
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 10px;
    }

    .sidebar-block {
      background: #fffdf7;
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 10px;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .sidebar-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    button {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #ffffff;
      color: var(--text-main);
      font-size: 12px;
      padding: 6px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      font-family: inherit;
    }

    button:hover { background: #f0ece3; }

    .btn-primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .btn-primary:hover { background: #8f2222; }

    .btn-danger {
      background: white;
      color: var(--danger);
      border-color: var(--danger);
    }
    .btn-danger:hover { background: #fff1f1; }

    .thread-list {
      max-height: 320px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .thread-item {
      padding: 8px 10px;
      border-radius: 10px;
      margin-bottom: 6px;
      cursor: pointer;
      border: 1px solid transparent;
      background: transparent;
    }
    .thread-item.active {
      background: #fffdf7;
      border-color: var(--accent);
    }
    .thread-item-title {
      font-size: 13px;
      font-weight: 600;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .thread-item-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .sources-list {
      max-height: 240px;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .source-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: #ffffff;
      font-size: 12px;
    }
    .source-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .source-name {
      font-weight: 600;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .source-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .app-container {
      background: var(--bg-panel);
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
    }

    .app-header {
      padding: 12px 16px 10px;
      border-bottom: 1px solid var(--border-subtle);
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg-panel);
    }

    .app-header-main {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }

    .app-header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .muted {
      color: var(--text-muted);
      font-size: 12px;
    }

    .chat-container {
      flex: 1;
      padding: 16px 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .empty-state {
      margin: auto;
      text-align: center;
      max-width: 460px;
      color: var(--text-muted);
      font-size: 13px;
      padding: 20px;
      border-radius: 16px;
      border: 1px dashed var(--border-subtle);
      background: #fdfaf3;
    }

    .message {
      max-width: 78%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.55;
      white-space: pre-wrap;
      background: #f7f3ea;
      border: 1px solid var(--border-subtle);
    }

    .message.user {
      align-self: flex-end;
      background: #fdf6f2;
      border-color: var(--accent-soft);
    }

    .message.assistant {
      align-self: flex-start;
      background: #f7f3ea;
    }

    .message .meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .status-bar {
      font-size: 11px;
      padding: 6px 20px;
      color: var(--text-muted);
      border-top: 1px solid var(--border-subtle);
    }

    .input-container {
      display: flex;
      gap: 8px;
      padding: 10px 16px 12px;
      border-top: 1px solid var(--border-subtle);
      background: #f9f7f2;
    }

    .input-container textarea {
      flex: 1;
      resize: none;
      min-height: 40px;
      max-height: 140px;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid var(--border-subtle);
      background: #ffffff;
      color: var(--text-main);
      font-size: 14px;
      font-family: inherit;
    }

    .input-container textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(177, 43, 43, 0.2);
    }

    .login-shell {
      width: 100%;
      max-width: 720px;
      margin: 16px;
      background: #fffdf7;
      border: 1px solid var(--border-subtle);
      border-radius: 18px;
      padding: 16px;
      height: calc(100vh - 32px);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .login-shell h2 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .login-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .login-row input {
      flex: 1;
      min-width: 240px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      font-family: inherit;
      font-size: 14px;
    }

    .hide { display: none !important; }

    @media (max-width: 980px) {
      .app-shell {
        grid-template-columns: 1fr;
        height: 100vh;
        margin: 0;
        border-radius: 0;
      }
    }
  </style>
</head>
<body>

  <!-- LOGIN VIEW -->
  <div id="loginView" class="login-shell hide">
    <h2>Sign in</h2>
    <div class="muted">
      This tool uses Supabase Auth. Enter your email to receive a magic link.
    </div>
    <div class="login-row">
      <input id="emailInput" type="email" placeholder="you@tenutolabs.com" />
      <button id="magicLinkBtn" class="btn-primary">Send magic link</button>
    </div>
    <div class="muted">
      After you click the magic link, you’ll be signed in automatically here.
    </div>
    <div class="status-bar">
      <span id="loginStatus">Ready.</span>
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="appView" class="app-shell hide">
    <aside class="sidebar">
      <div class="sidebar-block">
        <div class="sidebar-header">
          <div class="sidebar-title">Account</div>
          <button id="logoutBtn" class="btn-danger">Log out</button>
        </div>
        <div class="muted" id="userEmail">—</div>
      </div>

      <div class="sidebar-block">
        <div class="sidebar-header">
          <div class="sidebar-title">Threads</div>
          <button id="newThreadBtn" class="btn-primary">+ New</button>
        </div>
        <div id="threadList" class="thread-list"></div>
        <div class="login-row" style="margin-top:8px;">
          <button id="renameThreadBtn">Rename</button>
          <button id="deleteThreadBtn" class="btn-danger">Delete</button>
        </div>
      </div>

      <div class="sidebar-block">
        <div class="sidebar-header">
          <div class="sidebar-title">Sources</div>
          <button id="refreshSourcesBtn">Refresh</button>
        </div>
        <div class="muted" style="margin-bottom:8px;">
          Admins can toggle which authors are searched.
        </div>
        <div id="sourcesList" class="sources-list"></div>
      </div>
    </aside>

    <div class="app-container">
      <header class="app-header">
        <div class="app-header-main">
          <h1>Tenuto Newsletter Development Tool</h1>
          <div class="header-actions">
            <span class="muted">Current thread: <b id="currentThreadName">—</b></span>
          </div>
        </div>
        <p class="muted" style="margin:6px 0 0;">
          Persistent memory is stored per user in Supabase. Replies are plain text (no Markdown).
        </p>
      </header>

      <div id="chat" class="chat-container"></div>

      <div class="status-bar">
        <span id="status">Ready.</span>
      </div>

      <div class="input-container">
        <textarea id="input" placeholder="Ask a question..."></textarea>
        <button id="sendBtn" class="btn-primary">Send</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // CONFIG
    // ==========================
    const SUPABASE_URL = "https://qzznxnidyhqadgsutvkb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6em54bmlkeWhxYWRnc3V0dmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMzk0NTQsImV4cCI6MjA3ODcxNTQ1NH0.pRK0EnPp6jiXq10ySx7WKiHXHI7S9KwzOBSnXxqsBiQ";
    const API_BASE_URL = "https://newsletter-tool-mfsi.onrender.com"; // your Render backend base URL

    // Allowlist gate (UI-level)
    const ALLOWED_EMAILS = new Set([
      "hans@tenutolabs.com",
      "sanjay@tenutolabs.com",
      "joseph@tenutolabs.com",
    ]);

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==========================
    // DOM
    // ==========================
    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");

    const emailInput = document.getElementById("emailInput");
    const magicLinkBtn = document.getElementById("magicLinkBtn");
    const loginStatus = document.getElementById("loginStatus");

    const logoutBtn = document.getElementById("logoutBtn");
    const userEmailEl = document.getElementById("userEmail");

    const threadListEl = document.getElementById("threadList");
    const newThreadBtn = document.getElementById("newThreadBtn");
    const renameThreadBtn = document.getElementById("renameThreadBtn");
    const deleteThreadBtn = document.getElementById("deleteThreadBtn");
    const currentThreadNameEl = document.getElementById("currentThreadName");

    const sourcesListEl = document.getElementById("sourcesList");
    const refreshSourcesBtn = document.getElementById("refreshSourcesBtn");

    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const statusEl = document.getElementById("status");

    // ==========================
    // STATE
    // ==========================
    let accessToken = null;
    let currentThreadId = null;
    let threads = [];
    let messages = [];
    let sources = [];

    // ==========================
    // Helpers
    // ==========================
    function showLogin() {
      loginView.classList.remove("hide");
      appView.classList.add("hide");
    }

    function showApp() {
      loginView.classList.add("hide");
      appView.classList.remove("hide");
    }

    function setStatus(text) {
      statusEl.textContent = text;
    }

    async function apiFetch(path, options = {}) {
      if (!accessToken) throw new Error("Missing access token");
      const resp = await fetch(`${API_BASE_URL}${path}`, {
        ...options,
        headers: {
          ...(options.headers || {}),
          "Content-Type": "application/json",
          "Authorization": `Bearer ${accessToken}`,
        },
      });
      return resp;
    }

    // ==========================
    // Auth
    // ==========================
    async function loadSession() {
      const { data } = await supabaseClient.auth.getSession();
      const session = data?.session || null;
      if (!session) return null;
      return session;
    }

    async function handleSignedIn(session) {
      accessToken = session.access_token;
      userEmailEl.textContent = session.user?.email || "Signed in";
      showApp();
      await refreshThreads();
      await refreshSources();
    }

    async function handleSignedOut() {
      accessToken = null;
      currentThreadId = null;
      threads = [];
      messages = [];
      sources = [];
      chatEl.innerHTML = "";
      threadListEl.innerHTML = "";
      sourcesListEl.innerHTML = "";
      currentThreadNameEl.textContent = "—";
      showLogin();
    }

    // Keep email lowercase in UI
    emailInput.addEventListener("input", () => {
      emailInput.value = (emailInput.value || "").toLowerCase();
    });

    magicLinkBtn.addEventListener("click", async () => {
      const email = ((emailInput.value || "").trim()).toLowerCase();
      if (!email) return;

      // Allowlist gate
      if (!ALLOWED_EMAILS.has(email)) {
        loginStatus.textContent = "This email is not authorized for this tool.";
        return;
      }

      loginStatus.textContent = "Sending magic link...";
      const { error } = await supabaseClient.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: window.location.href, // keep it simple
        }
      });

      if (error) {
        console.error(error);
        loginStatus.textContent = "Error sending link.";
      } else {
        loginStatus.textContent = "Magic link sent. Check your email.";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
    });

    supabaseClient.auth.onAuthStateChange(async (event, session) => {
      if (event === "SIGNED_IN" && session) {
        await handleSignedIn(session);
      } else if (event === "SIGNED_OUT") {
        await handleSignedOut();
      }
    });

    // ==========================
    // Threads
    // ==========================
    async function refreshThreads() {
      const resp = await apiFetch("/threads", { method: "GET" });
      if (!resp.ok) {
        console.error(await resp.text());
        setStatus("Failed to load threads.");
        return;
      }
      threads = await resp.json();

      // Auto-select first thread or create one
      if (!threads.length) {
        await createThread("New thread");
        return;
      }

      if (!currentThreadId || !threads.find(t => t.id === currentThreadId)) {
        currentThreadId = threads[0].id;
      }

      renderThreadList();
      await loadMessages(currentThreadId);
    }

    async function createThread(name) {
      const resp = await apiFetch("/threads", {
        method: "POST",
        body: JSON.stringify({ name }),
      });
      if (!resp.ok) {
        console.error(await resp.text());
        setStatus("Failed to create thread.");
        return;
      }
      const t = await resp.json();
      currentThreadId = t.id;
      await refreshThreads();
    }

    async function renameCurrentThread() {
      if (!currentThreadId) return;
      const current = threads.find(t => t.id === currentThreadId);
      const newName = window.prompt("New thread name:", current?.name || "New thread");
      if (!newName) return;

      const resp = await apiFetch(`/threads/${currentThreadId}`, {
        method: "PATCH",
        body: JSON.stringify({ name: newName }),
      });
      if (!resp.ok) {
        console.error(await resp.text());
        setStatus("Failed to rename thread.");
        return;
      }
      await refreshThreads();
    }

    async function deleteCurrentThread() {
      if (!currentThreadId) return;
      const ok = window.confirm("Delete this thread permanently?");
      if (!ok) return;

      const resp = await apiFetch(`/threads/${currentThreadId}`, { method: "DELETE" });
      if (!resp.ok) {
        console.error(await resp.text());
        setStatus("Failed to delete thread.");
        return;
      }
      currentThreadId = null;
      await refreshThreads();
    }

    function renderThreadList() {
      threadListEl.innerHTML = "";
      threads.forEach((t) => {
        const div = document.createElement("div");
        div.classList.add("thread-item");
        if (t.id === currentThreadId) div.classList.add("active");

        const title = document.createElement("div");
        title.classList.add("thread-item-title");
        title.textContent = t.name || "Untitled";

        const meta = document.createElement("div");
        meta.classList.add("thread-item-meta");
        const updated = new Date(t.updated_at);
        meta.textContent = `Updated: ${updated.toLocaleDateString()} ${updated.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

        div.appendChild(title);
        div.appendChild(meta);

        div.addEventListener("click", async () => {
          currentThreadId = t.id;
          renderThreadList();
          await loadMessages(currentThreadId);
        });

        threadListEl.appendChild(div);
      });

      const current = threads.find(t => t.id === currentThreadId);
      currentThreadNameEl.textContent = current ? (current.name || "Untitled") : "—";
    }

    newThreadBtn.addEventListener("click", () => createThread("New thread"));
    renameThreadBtn.addEventListener("click", renameCurrentThread);
    deleteThreadBtn.addEventListener("click", deleteCurrentThread);

    // ==========================
    // Messages
    // ==========================
    async function loadMessages(threadId) {
      if (!threadId) return;
      const resp = await apiFetch(`/threads/${threadId}/messages`, { method: "GET" });
      if (!resp.ok) {
        console.error(await resp.text());
        setStatus("Failed to load messages.");
        return;
      }
      messages = await resp.json();
      renderMessages();
      setStatus("Ready.");
    }

    function renderMessages() {
      chatEl.innerHTML = "";

      if (!messages.length) {
        const empty = document.createElement("div");
        empty.classList.add("empty-state");
        empty.innerHTML = `
          <h2>Start a conversation</h2>
          <p>
            This thread’s history is stored on the backend and will be used as context
            for future answers (per user).
          </p>
        `;
        chatEl.appendChild(empty);
        chatEl.scrollTop = 0;
        return;
      }

      messages.forEach((m) => {
        const div = document.createElement("div");
        div.classList.add("message", m.role);

        const meta = document.createElement("div");
        meta.classList.add("meta");
        const who = m.role === "user" ? "You" : "Assistant";
        const time = new Date(m.created_at).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        meta.textContent = `${who} • ${time}`;

        const body = document.createElement("div");
        body.textContent = m.content;

        div.appendChild(meta);
        div.appendChild(body);
        chatEl.appendChild(div);
      });

      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // ==========================
    // Sources (Admin toggles)
    // ==========================
    async function refreshSources() {
      const resp = await apiFetch("/sources", { method: "GET" });
      if (!resp.ok) {
        console.error(await resp.text());
        return;
      }
      sources = await resp.json();
      renderSources();
    }

    function renderSources() {
      sourcesListEl.innerHTML = "";

      sources.forEach((s) => {
        const row = document.createElement("div");
        row.classList.add("source-row");

        const left = document.createElement("div");
        left.classList.add("source-left");

        const name = document.createElement("div");
        name.classList.add("source-name");
        name.textContent = s.display_name;

        const meta = document.createElement("div");
        meta.classList.add("source-meta");
        meta.textContent = `${s.source_type} • author_id=${s.author_id}`;

        left.appendChild(name);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.classList.add("toggle");

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!s.enabled;

        const label = document.createElement("span");
        label.textContent = s.enabled ? "Enabled" : "Disabled";

        cb.addEventListener("change", async () => {
          const resp = await apiFetch(`/admin/sources/${s.id}`, {
            method: "PATCH",
            body: JSON.stringify({ enabled: cb.checked }),
          });

          if (!resp.ok) {
            const text = await resp.text();
            console.warn("Toggle failed:", text);
            cb.checked = !cb.checked;
            alert("You are not an admin (Hans/Sanjay/Joseph only, depending on your roles).");
            return;
          }

          s.enabled = cb.checked;
          label.textContent = s.enabled ? "Enabled" : "Disabled";
        });

        right.appendChild(cb);
        right.appendChild(label);

        row.appendChild(left);
        row.appendChild(right);

        sourcesListEl.appendChild(row);
      });
    }

    refreshSourcesBtn.addEventListener("click", refreshSources);

    // ==========================
    // Ask
    // ==========================
    async function sendMessage() {
      const question = (inputEl.value || "").trim();
      if (!question || !currentThreadId) return;

      inputEl.value = "";
      inputEl.focus();
      sendBtn.disabled = true;
      setStatus("Thinking...");

      // optimistic UI: append user message locally
      messages.push({
        id: "local-" + Date.now(),
        role: "user",
        content: question,
        created_at: new Date().toISOString(),
      });
      renderMessages();

      try {
        const resp = await apiFetch("/ask", {
          method: "POST",
          body: JSON.stringify({
            thread_id: currentThreadId,
            question,
            k: 10,
            history_limit: 18
          }),
        });

        if (!resp.ok) {
          console.error(await resp.text());
          messages.push({
            id: "local-err-" + Date.now(),
            role: "assistant",
            content: "Backend error.",
            created_at: new Date().toISOString(),
          });
          renderMessages();
          setStatus("Error.");
          return;
        }

        await loadMessages(currentThreadId);
        setStatus("Ready.");
      } catch (e) {
        console.error(e);
        messages.push({
          id: "local-neterr-" + Date.now(),
          role: "assistant",
          content: "Network error communicating with backend.",
          created_at: new Date().toISOString(),
        });
        renderMessages();
        setStatus("Network error.");
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // ==========================
    // Init
    // ==========================
    (async () => {
      const session = await loadSession();
      if (session) {
        await handleSignedIn(session);
      } else {
        showLogin();
      }
    })();
  </script>
</body>
</html>
